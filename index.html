<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Market Expansion : Leads Wanonniwat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }

    .legend {
      position: absolute; bottom: 16px; left: 16px;
      background: white; padding: 14px 16px; border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,.15); font-family: sans-serif; font-size: 16px;
      min-width: 240px;
    }
    .legend .row { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
    .dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; }
    .dot.red { background: #d00; }
    .dot.blue { background: #2a62ff; }
    .dot.green { background: #2ecc71; }

    .reach {
      position: absolute;
      top: 16px;
      left: 16px;
      background: linear-gradient(135deg, #ffffff, #f9fbff);
      padding: 16px 20px;
      border-radius: 14px;
      border: 1px solid #dce3f0;
      box-shadow: 0 4px 16px rgba(0,0,0,.15);
      font-family: "Segoe UI", sans-serif;
      font-size: 15px;
      min-width: 380px;
    }
    .reach .title { font-weight: 700; font-size: 16px; margin-bottom: 10px; color: #2c3e50; border-bottom: 2px solid #4a90e2; padding-bottom: 6px; }
    .reach .row { display: flex; flex-direction: column; margin: 8px 0; }
    .reach .label { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .reach .bar { height: 10px; background: #e0e6f5; border-radius: 5px; overflow: hidden; }
    .reach .bar span { display: block; height: 100%; background: linear-gradient(90deg, #4a90e2, #50c9ce); }

    /* Date Filter */
    .filterbox { 
      background: linear-gradient(135deg, #ffffff, #f7fffb); 
      padding: 14px 16px; 
      border-radius: 14px; 
      border: 1px solid #cfe9db; 
      box-shadow: 0 4px 16px rgba(0,0,0,.15);
      font-family: "Segoe UI", sans-serif; font-size: 14px; min-width: 320px;
    }
    .filterbox .title { font-weight: 700; font-size: 16px; margin-bottom: 10px; color: #1f5135; border-bottom: 2px solid #6fd3a7; padding-bottom: 6px; }
    .filterbox .row { display: grid; grid-template-columns: auto 1fr; gap: 8px 10px; align-items: center; margin-bottom: 8px; }
    .filterbox label { white-space: nowrap; }
    .filterbox input[type="date"] { padding: 6px 8px; border: 1px solid #d3e6dc; border-radius: 8px; }
    .filterbox .actions { display: flex; gap: 8px; }
    .filterbox button { 
      padding: 8px 12px; border-radius: 10px; border: 1px solid #bfe8d3; cursor: pointer; background: #e9fff5;
    }
    .filterbox button:hover { filter: brightness(0.98); }
    .filterbox .stat { margin-top: 8px; font-size: 13px; color: #1f5135; }

    /* Sales summary boxes */
    .salesbox { 
      background: linear-gradient(135deg, #ffffff, #fffaf5);
      padding: 16px 20px;
      border-radius: 14px;
      border: 1px solid #f0dcc3;
      box-shadow: 0 4px 16px rgba(0,0,0,.15);
      font-family: "Segoe UI", sans-serif;
      font-size: 15px;
      min-width: 320px;
      margin-top: 10px; 
    }
    .salesbox .title { font-weight: 700; font-size: 16px; margin-bottom: 10px; color: #6b3f00; border-bottom: 2px solid #ffb257; padding-bottom: 6px; }
    .salesbox .row { display: flex; justify-content: space-between; align-items: center; background: #fff4e5; margin: 6px 0; padding: 8px 12px; border-radius: 10px; }
    .salesbox .value { font-weight: 700; font-size: 18px; color: #7a4d00; }

    .salesbox.cumu{
      background: linear-gradient(135deg,#ffffff,#f4fff7);
      border-color:#cfe9db;
    }
    .salesbox.cumu .title{
      color:#155e3b;border-bottom-color:#6fd3a7;
    }
    .salesbox.cumu .row{
      background:#effcf5;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ===== Branch (fixed) =====
    const branch = {
      name: "‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏ß‡∏≤‡∏ô‡∏£‡∏ô‡∏¥‡∏ß‡∏≤‡∏™",
      lat: 17.62932338805625,
      lng: 103.76765900596575,
      radius_m: 80000
    };

    // ===== Market Size (‡∏ê‡∏≤‡∏ô DBD ‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î) =====
    // ‡∏ê‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á DBD Market Quantity)
    const MARKET_BASE = {
      "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ": 151,
      "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£": 85,
      "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨": 33,
      "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°": 63
    };

    // ===== Google Sheet config =====
    const SHEET_ID   = "1UZxR7z7GFmqzYHkkbfeH6pF17OgkucKvCqYjbRf4NJw";
    const SHEET_NAME = "WNN";

    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• leads (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å Google Sheet)
    let blueData  = []; // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà DBD
    let greenData = []; // ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô DBD

    // ===== Icons =====
    const redIcon = L.icon({ iconUrl: "https://maps.google.com/mapfiles/ms/icons/red-dot.png", iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
    const blueIcon = L.icon({ iconUrl: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png", iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
    const greenIcon = L.icon({ iconUrl: "https://maps.google.com/mapfiles/ms/icons/green-dot.png", iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });

    // ===== Map =====
    const map = L.map("map", { center: [branch.lat, branch.lng], zoom: 8 });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OpenStreetMap contributors" }).addTo(map);

    // Branch marker & radius
    L.marker([branch.lat, branch.lng], { icon: redIcon })
      .addTo(map)
      .bindPopup(`<b>${branch.name}</b><br><a href="https://www.google.com/maps?q=${branch.lat},${branch.lng}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps</a>`)
      .openPopup();
    const circle = L.circle([branch.lat, branch.lng], { radius: branch.radius_m, color: "#d00", weight: 2, fillColor: "#d00", fillOpacity: 0.08 }).addTo(map);

    // Layers
    const layerBlue = L.layerGroup().addTo(map);
    const layerGreen = L.layerGroup().addTo(map);

    // Popup
    function popupHTML(p) {
      const liters = (v) => (v == null ? "0" : v);
      const dateDisp = p.date || "-";
      const resourceLine = p.resource ? `‚öôÔ∏è <b>Resource:</b> ${p.resource}<br>` : "";
      return `
        <b>${p.name}</b><br>
        üìÖ <b>Date:</b> ${dateDisp}<br>
        üè∑Ô∏è <b>Supplier:</b> ${p.supplier ?? "-"}<br>
        ‚õΩ <b>DS/G91/G95:</b> ${liters(p.DS)}/${liters(p.G91)}/${liters(p.G95)} ‡∏•‡∏¥‡∏ï‡∏£<br>
        üìç <b>${p.amphoe ?? ""}${p.province ? ", "+p.province : ""}</b><br>
        ${resourceLine}
        üë§ <b>Sender:</b> ${p.sender ?? "-"}<br>
        üìù <b>Note:</b> ${p.note || "-"}<br>
        <a href="https://www.google.com/maps?q=${p.lat},${p.lng}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps</a>`;
    }
    function addPoints(data, icon, layer) {
      data.forEach(p => {
        L.marker([p.lat, p.lng], { icon }).addTo(layer).bindPopup(popupHTML(p));
      });
    }

    // ===== Reach box =====
    const reachCtrl = L.control({ position: "topleft" });
    reachCtrl.onAdd = () => {
      const div = L.DomUtil.create("div", "reach");
      div.innerHTML = `
        <div class="title">üéØ Target Reach (Leads): Actual / Market Size</div>
        <div id="reachRows"></div>`;
      L.DomEvent.disableClickPropagation(div);
      return div;
    };
    reachCtrl.addTo(map);

    function renderReach(fBlue, fGreen) {
      const byProvDBD = {};
      const byProvNon = {};

      fGreen.forEach(p => {
        const prov = p.province || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î";
        byProvDBD[prov] = (byProvDBD[prov] || 0) + 1;
      });
      fBlue.forEach(p => {
        const prov = p.province || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î";
        byProvNon[prov] = (byProvNon[prov] || 0) + 1;
      });

      const wrap = document.getElementById("reachRows");
      const allProvs = new Set([
        ...Object.keys(MARKET_BASE),
        ...Object.keys(byProvDBD),
        ...Object.keys(byProvNon)
      ]);

      let html = "";
      allProvs.forEach(prov => {
        const base   = MARKET_BASE[prov] || 0;
        const extra  = byProvNon[prov] || 0;      // non-DBD ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏•‡∏≤‡∏î
        const market = base + extra;
        const actual = byProvDBD[prov] || 0;      // DBD = Actual Reach
        const pct    = market ? (actual / market) * 100 : 0;

        html += `
          <div class="row">
            <div class="label">
              <span>${prov}</span>
              <span>${actual}/${market} (${pct.toFixed(2)}%)</span>
            </div>
            <div class="bar">
              <span style="width:${Math.min(pct,100)}%"></span>
            </div>
          </div>`;
      });

      wrap.innerHTML = html || `<div style="opacity:.8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`;
    }

    function renderAll(filteredBlue = blueData, filteredGreen = greenData) {
      layerBlue.clearLayers();
      layerGreen.clearLayers();
      addPoints(filteredBlue, blueIcon, layerBlue);
      addPoints(filteredGreen, greenIcon, layerGreen);

      const b = L.latLngBounds();
      b.extend(circle.getBounds());
      layerBlue.eachLayer(l => b.extend(l.getLatLng()));
      layerGreen.eachLayer(l => b.extend(l.getLatLng()));
      if (b.isValid()) map.fitBounds(b.pad(0.1));

      updateCounts(filteredBlue, filteredGreen);
      renderReach(filteredBlue, filteredGreen);
    }

    // ===== Controls (Filter + Two summary boxes) =====
    const filterCtrl = L.control({ position: "topright" });
    filterCtrl.onAdd = () => {
      const div = L.DomUtil.create("div", "filterbox");
      div.innerHTML = `
        <div class="title">üìÜ Filter by Date</div>
        <div class="row">
          <label for="startDate">‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
          <input id="startDate" type="date" />
        </div>
        <div class="row">
          <label for="endDate">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
          <input id="endDate" type="date" />
        </div>
        <div class="actions">
          <button id="applyBtn">Apply</button>
          <button id="clearBtn">Clear</button>
        </div>
        <div class="stat" id="filterStat">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>`;
      L.DomEvent.disableClickPropagation(div);
      return div;
    };
    filterCtrl.addTo(map);

    // Box 1: ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const salesCtrl = L.control({ position: "topright" });
    salesCtrl.onAdd = () => {
      const div = L.DomUtil.create("div", "salesbox");
      div.innerHTML = `
        <div class="title">üíº ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏£‡∏¥‡∏á <i>(‡∏ï‡∏≤‡∏° Filter Date)</i></div>
        <div class="row"><span>Actual Leads (‡∏£‡∏≤‡∏¢)</span><span class="value" id="cntCustomers">0</span></div>
        <div class="row"><span>Actual Market Size (‡∏•‡∏¥‡∏ï‡∏£)</span><span class="value" id="sumLiters">0</span></div>`;
      L.DomEvent.disableClickPropagation(div);
      return div;
    };
    salesCtrl.addTo(map);

    // Box 2: Cumulative (1 Jul ‚Üí end)
    const cumuCtrl = L.control({ position: "topright" });
    cumuCtrl.onAdd = () => {
      const div = L.DomUtil.create("div", "salesbox cumu");
      div.innerHTML = `
        <div class="title">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏£‡∏¥‡∏á (Cumulative)</div>
        <div class="row"><span>Leads ‡∏™‡∏∞‡∏™‡∏° (‡∏£‡∏≤‡∏¢)</span><span class="value" id="cumCntCustomers">0</span></div>
        <div class="row"><span>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏•‡∏¥‡∏ï‡∏£‡∏™‡∏∞‡∏™‡∏°</span><span class="value" id="cumSumLiters">0</span></div>
        <div class="stat" id="cumuNote"></div>`;
      L.DomEvent.disableClickPropagation(div);
      return div;
    };
    cumuCtrl.addTo(map);

    // ===== Helpers & summaries =====
    function parseYMD(s) { if (!s) return null; const [y,m,d] = s.split('-').map(Number); return new Date(y, m-1, d); }
    function within(dateStr, startStr, endStr) {
      if (!startStr && !endStr) return true;
      const d = parseYMD(dateStr); if (!d) return false;
      const s = startStr ? parseYMD(startStr) : null;
      const e = endStr ? parseYMD(endStr) : null;
      if (s && d < s) return false; if (e && d > e) return false; return true;
    }
    function fmt(n){ return n.toLocaleString(); }
    function allData(){ return [...blueData, ...greenData]; }

    function dataMinMax() {
      const dates = allData().map(p => parseYMD(p.date)).filter(Boolean);
      if (!dates.length) return {min:null,max:null};
      return {min: new Date(Math.min(...dates)), max: new Date(Math.max(...dates))};
    }

    function updateCounts(fBlue, fGreen) {
      const all = [...fBlue, ...fGreen];
      const customers = all.length;
      const liters = all.reduce((acc, p) => acc + (p.DS||0) + (p.G91||0) + (p.G95||0), 0);
      document.getElementById('cntCustomers').textContent = fmt(customers);
      document.getElementById('sumLiters').textContent = fmt(liters);
    }

    function updateCumulative(endStr, hasAnyFilter) {
      const {max} = dataMinMax();
      if (!hasAnyFilter) {
        const customers = allData().length;
        const liters = allData().reduce((acc,p)=>acc+(p.DS||0)+(p.G91||0)+(p.G95||0),0);
        document.getElementById('cumCntCustomers').textContent = fmt(customers);
        document.getElementById('cumSumLiters').textContent = fmt(liters);
        document.getElementById('cumuNote').textContent = '‡∏ä‡πà‡∏ß‡∏á: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        return;
      }
      const end = endStr ? parseYMD(endStr) : max || new Date();
      const start = new Date(end.getFullYear(), 6, 1); // 6 = July
      const inRange = allData().filter(p => {
        const d = parseYMD(p.date);
        return d && d >= start && d <= end;
      });
      const customers = inRange.length;
      const liters = inRange.reduce((acc,p)=>acc+(p.DS||0)+(p.G91||0)+(p.G95||0),0);
      document.getElementById('cumCntCustomers').textContent = fmt(customers);
      document.getElementById('cumSumLiters').textContent = fmt(liters);
      const pad = (n)=>String(n).padStart(2,'0');
      document.getElementById('cumuNote').textContent =
        `‡∏ä‡πà‡∏ß‡∏á: 01/${pad(start.getMonth()+1)}/${start.getFullYear()} - ${pad(end.getDate())}/${pad(end.getMonth()+1)}/${end.getFullYear()}`;
    }

    function applyFilter() {
      if (!blueData.length && !greenData.length) return; // ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à

      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const fGreen = greenData.filter(p => within(p.date, start, end));
      const fBlue  = blueData.filter(p => within(p.date, start, end));
      renderAll(fBlue, fGreen);

      const stat = document.getElementById('filterStat');
      if (!start && !end) stat.textContent = '‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
      else if (start && end) stat.textContent = `‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${start} ‡∏ñ‡∏∂‡∏á ${end}`;
      else if (start) stat.textContent = `‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${start}`;
      else stat.textContent = `‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${end}`;

      updateCumulative(end, !!(start || end));
    }
    function clearFilter() {
      document.getElementById('startDate').value='';
      document.getElementById('endDate').value='';
      applyFilter();
    }
    function wireFilterEvents() {
      document.getElementById('applyBtn').addEventListener('click', applyFilter);
      document.getElementById('clearBtn').addEventListener('click', clearFilter);
      ['startDate','endDate'].forEach(id => {
        document.getElementById(id).addEventListener('change', applyFilter);
      });
    }

    // ===== ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets =====
    function parseSheetDateCell(cell) {
      if (!cell) return null;
      if (cell.f) {
        const d = new Date(cell.f);
        if (!isNaN(d)) return d;
      }
      if (typeof cell.v === "string") {
        if (/Date\(/.test(cell.v)) {
          const m = cell.v.match(/Date\((\d+),(\d+),(\d+)\)/);
          if (m) return new Date(Number(m[1]), Number(m[2]), Number(m[3]));
        }
        const d = new Date(cell.v);
        if (!isNaN(d)) return d;
      }
      if (typeof cell.v === "number") {
        const base = new Date(1899,11,30);
        return new Date(base.getTime() + cell.v * 86400000);
      }
      return null;
    }

    function toYMD(dateObj) {
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth()+1).padStart(2,'0');
      const d = String(dateObj.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }

    async function loadSheetData() {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&headers=1&tqx=out:json`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}')+1));
        const rows = json.table.rows || [];

        blueData  = [];
        greenData = [];

        rows.forEach(r => {
          const c = r.c;
          if (!c) return;

          const name = c[2]?.v;
          if (!name) return;

          const dateCell = c[1] || c[3];
          const dObj = parseSheetDateCell(dateCell);
          if (!dObj) return;
          const date = toYMD(dObj);

          const DS  = Number(c[4]?.v || 0);
          const G91 = Number(c[5]?.v || 0);
          const G95 = Number(c[6]?.v || 0);
          const supplier = c[7]?.v || "";
          const latlngStr = c[8]?.v || "";
          const [latStr, lngStr] = latlngStr.split(",").map(s => s && s.trim());
          const lat = parseFloat(latStr);
          const lng = parseFloat(lngStr);
          if (!isFinite(lat) || !isFinite(lng)) return;

          const amphoe   = c[9]?.v || "";
          const province = c[10]?.v || "";
          const resource = c[11]?.v || "";
          const sender   = c[12]?.v || "";
          const note     = c[13]?.v || "";
          const BU       = c[14]?.v || "";
          const isDBD    = !!(c[15]?.v);

          const obj = {name,date,DS,G91,G95,supplier,lat,lng,amphoe,province,resource,sender,note,BU,isDBD};

          if (isDBD) greenData.push(obj);   // ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô DBD
          else       blueData.push(obj);    // ‡∏ô‡∏≠‡∏Å DBD
        });

        renderAll(blueData, greenData);
        updateCumulative(null, false);
      } catch (err) {
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err);
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå / ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ï");
      }
    }

    // Initial
    wireFilterEvents();
    loadSheetData();

    // Legend
    const legend = L.control({ position: "bottomleft" });
    legend.onAdd = () => {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <div style="font-weight:600; margin-bottom:4px;">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</div>
        <div class="row"><span class="dot red"></span> ‡∏™‡∏≤‡∏Ç‡∏≤ + ‡∏£‡∏±‡∏®‡∏°‡∏µ 80 ‡∏Å‡∏°.</div>
        <div class="row"><span class="dot blue"></span> Leads ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏ô‡∏≠‡∏Å DBD)</div>
        <div class="row"><span class="dot green"></span> Leads ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô DBD</div>`;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
